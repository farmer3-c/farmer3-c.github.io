---
layout: post
title: "çˆ¬å–ä¸­å›½å·¥å•†é“¶è¡Œäººæ°‘å¸å³æœŸå¤–æ±‡ç‰Œä»·æ•°æ®"
subtitle: ""
date: 2026-01-20 22:18:28 +0800
author: "farmer3-c"
header-img: "img/post-bg-2015.jpg"
tags: [çˆ¬è™«]
mathjax: true
---
## çˆ¬å–å•æ—¥æ•°æ®

#### å‰æœŸå‡†å¤‡

æˆ‘è¦çˆ¬å–çš„ç½‘ç«™æ˜¯

    https://www.icbc.com.cn/ICBC/%e9%87%91%e8%9e%8d%e4%bf%a1%e6%81%af/%e8%a1%8c%e6%83%85%e6%95%b0%e6%8d%ae/%e4%ba%ba%e6%b0%91%e5%b8%81%e5%8d%b3%e6%9c%9f%e5%a4%96%e6%b1%87%e7%89%8c%e4%bb%b7/

æ•°æ®æ˜¯è¿™æ ·çš„ï¼šå¸ç§ã€é“¶è¡Œä¹°å…¥ä»·ã€é“¶è¡Œå–å‡ºä»·ã€å‘å¸ƒæ—¶é—´

![1](/img/in-post/python_img/å±å¹•æˆªå›¾%202026-01-25%20114748.png)

ç¯å¢ƒï¼špython 3.12.2

#### å¯»æ‰¾ç½‘ç»œè¯·æ±‚æ¥å£

åœ¨æµè§ˆå™¨ä¸­æŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œç„¶åç‚¹å‡»Networkï¼Œå‹¾é€‰ Preserve log

* é€‰æ‹© Fetch / XHR

    `XMLHttpRequest (XHR)` å’Œ `Fetch API`éƒ½æ˜¯ç½‘é¡µå‘æœåŠ¡å™¨å‘èµ· HTTP è¯·æ±‚çš„æœºåˆ¶ã€‚Fetch API æ˜¯ä¸€ç§ç°ä»£çš„ã€åŸºäº Promise çš„æ›¿ä»£æ–¹æ¡ˆï¼Œç”¨äºå–ä»£è€æ—§çš„ã€åŸºäºå›è°ƒçš„ XHRï¼Œå®ƒæä¾›äº†æ›´ç®€æ´çš„è¯­æ³•å’Œæ›´é€‚åˆç°ä»£ç½‘é¡µå¼€å‘çš„åŠŸèƒ½ã€‚

* æ‰‹åŠ¨æ“ä½œé¡µé¢ï¼š

        é€‰æ‹©ä¸€ä¸ªæ—¥æœŸï¼ˆæ¯”å¦‚ 2021-01-25ï¼‰

        ç‚¹å‡»ã€æŸ¥è¯¢ã€‘

* Network åˆ—è¡¨é‡Œ æ–°å‡ºç°çš„ POST è¯·æ±‚

    ![](/img/in-post/python_img/å±å¹•æˆªå›¾%202026-01-25%20161550.png)
    å¯ä»¥ç¡®å®šå·¥å•†é“¶è¡Œæ–°ç‰ˆ PAPI çš„â€œå†å²å¤–æ±‡ç‰Œä»·æ¥å£â€ï¼š`POST https://papi.icbc.com.cn/exchanges/ns/history`

#### å¦‚ä½•ä½¿ç”¨æ¥å£

###### è¯·æ±‚æ–¹å¼

* POST

* Content-Type: application/json

###### è¯·æ±‚ä½“

```json
{
    "date": "2021-01-13",
    "currType": "",
    "serverType": "1"
}
```
ğŸ‘‰ è¿™ä¸ªæ¥å£ä¸æ”¯æŒâ€œæ—¶é—´åŒºé—´â€

ğŸ‘‰ éœ€è¦ä¸€å¤©ä¸€å¤©è¯·æ±‚

#### ç¼–å†™ä»£ç 

<details>
<summary>ç‚¹å‡»å±•å¼€/æŠ˜å ä»£ç </summary>
<div markdown="1">

```python
import requests

url = "https://papi.icbc.com.cn/exchanges/ns/history"

headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
    "Content-Type": "application/json",
    "Origin": "https://www.icbc.com.cn",
    "Referer": "https://www.icbc.com.cn/ICBC/%E9%87%91%E8%9E%8D%E4%BF%A1%E6%81%AF/%E8%A1%8C%E6%83%85%E6%95%B0%E6%8D%AE/%E4%BA%BA%E6%B0%91%E5%B8%81%E5%8D%B3%E6%9C%9F%E5%A4%96%E6%B1%87%E7%89%8C%E4%BB%B7/"
}

payload = {
    "date": "2021-01-13",
    "currType": "",
    "serverType": "1"
}

r = requests.post(url, headers=headers, json=payload, timeout=10)
r.raise_for_status()

print(r.json())

```
</div>
</details>

###### æŠ¥é”™ï¼š`[SSL: UNSAFE_LEGACY_RENEGOTIATION_DISABLED]`
* å½“å‰çš„ Python + OpenSSL ä¸å·¥è¡Œ PAPI æœåŠ¡å™¨çš„ TLS åå•†ä¸å…¼å®¹
* æ›´å‡†ç¡®åœ°è¯´ï¼š
    è¯·æ±‚è§¦å‘äº†â€œä¸å®‰å…¨çš„æ—§å¼ TLS é‡æ–°åå•†â€ï¼Œè€Œ Python é»˜è®¤å·²ç»ç¦æ­¢å®ƒ

**ä¸ºä»€ä¹ˆæµè§ˆå™¨èƒ½è®¿é—®ï¼Œæˆ‘çš„ Python ä¸èƒ½ï¼Ÿ**
æµè§ˆå™¨ï¼ˆChrome / Edgeï¼‰ï¼š

    è‡ªå¸¦ å®šåˆ¶ç‰ˆ TLS å®ç°

    å¯¹ä¸€äº›â€œå†å²é—ç•™é“¶è¡Œç³»ç»Ÿâ€åšäº†å…¼å®¹

    ä¼šæ‚„æ‚„é™çº§ / ç‰¹åˆ¤

Pythonï¼ˆrequests / urllib3ï¼‰ï¼š

    ç”¨çš„æ˜¯ OpenSSL å®˜æ–¹å®ç°

    é»˜è®¤ä¸¥æ ¼å®‰å…¨ç­–ç•¥

    ç›´æ¥æ‹’ç»è¿™ç§ TLS è¡Œä¸º

ğŸ‘‰ é“¶è¡Œç³»ç»Ÿï¼ˆå°¤å…¶æ˜¯å›½å†…ï¼‰

ğŸ‘‰ TLS é…ç½®è€ + ä¸­é—´ç½‘å…³

ğŸ‘‰ éå¸¸å®¹æ˜“è§¦å‘è¿™ä¸ªé—®é¢˜

###### è§£å†³æ–¹æ¡ˆ

* å½»åº•ç¦ç”¨ä»£ç†ï¼Œå“ªæ€•ä¸ç”¨ä»£ç†å·¥å…·ï¼Œä¹Ÿå¾ˆå¯èƒ½è¢«ç¯å¢ƒå˜é‡æ±¡æŸ“ã€‚
```python
import os

os.environ["HTTP_PROXY"] = ""
os.environ["HTTPS_PROXY"] = ""
os.environ["ALL_PROXY"] = ""
```       
* requests è°ƒç”¨æ—¶æ˜¾å¼æŒ‡å®šä»£ç†
```python
proxies = {
    "http": None,
    "https": None
}
# æˆ–è€…ç›´æ¥åœ¨ä»£ç é‡Œç¦ç”¨
```


* SSL Adapter + verify=False


```python
# ===== 2. SSL Adapterï¼šåŒæ—¶è§£å†³æ—§åè®®å’Œè¯ä¹¦éªŒè¯å†²çªé—®é¢˜ =====
class LegacySSLAdapter(requests.adapters.HTTPAdapter):
    def init_poolmanager(self, connections, maxsize, block=False):
        # åˆ›å»º SSL ä¸Šä¸‹æ–‡
        ctx = create_urllib3_context()
        # è§£å†³æ—§ç‰ˆ SSL åå•†é—®é¢˜
        ctx.options |= 0x4  # OP_LEGACY_SERVER_CONNECT
        # å…³é—­è¯ä¹¦éªŒè¯ï¼ˆå¯¹åº” verify=Falseï¼‰
        ctx.check_hostname = False  # å…ˆå…³é—­ä¸»æœºåæ£€æŸ¥
        ctx.verify_mode = ssl.CERT_NONE  # å†å…³é—­è¯ä¹¦éªŒè¯
        self.poolmanager = PoolManager(
            num_pools=connections,
            maxsize=maxsize,
            block=block,
            ssl_context=ctx
        )
```


<details>
<summary>ç‚¹å‡»å±•å¼€/æŠ˜å ä»£ç </summary>
<div markdown="1">

```python
import os
import requests
import ssl
from urllib3.poolmanager import PoolManager
from urllib3.util.ssl_ import create_urllib3_context

# ===== 1. å½»åº•ç¦ç”¨ä»£ç† =====
os.environ["HTTP_PROXY"] = ""
os.environ["HTTPS_PROXY"] = ""
os.environ["ALL_PROXY"] = ""

# ===== 2. SSL Adapterï¼šåŒæ—¶è§£å†³æ—§åè®®å’Œè¯ä¹¦éªŒè¯å†²çªé—®é¢˜ =====
class LegacySSLAdapter(requests.adapters.HTTPAdapter):
    def init_poolmanager(self, connections, maxsize, block=False):
        # åˆ›å»º SSL ä¸Šä¸‹æ–‡
        ctx = create_urllib3_context()
        # è§£å†³æ—§ç‰ˆ SSL åå•†é—®é¢˜
        ctx.options |= 0x4  # OP_LEGACY_SERVER_CONNECT
        # å…³é—­è¯ä¹¦éªŒè¯ï¼ˆå¯¹åº” verify=Falseï¼‰
        ctx.check_hostname = False  # å…ˆå…³é—­ä¸»æœºåæ£€æŸ¥
        ctx.verify_mode = ssl.CERT_NONE  # å†å…³é—­è¯ä¹¦éªŒè¯
        self.poolmanager = PoolManager(
            num_pools=connections,
            maxsize=maxsize,
            block=block,
            ssl_context=ctx
        )

url = "https://papi.icbc.com.cn/exchanges/ns/history"

headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
    "Content-Type": "application/json",
    "Origin": "https://www.icbc.com.cn",
    "Referer": "https://www.icbc.com.cn/ICBC/%E9%87%91%E8%9E%8D%E4%BF%A1%E6%81%AF/%E8%A1%8C%E6%83%85%E6%95%B0%E6%8D%AE/%E4%BA%BA%E6%B0%91%E5%B8%81%E5%8D%B3%E6%9C%9F%E5%A4%96%E6%B1%87%E7%89%8C%E4%BB%B7/"
}

payload = {
    "date": "2021-01-13",
    "currType": "",
    "serverType": "1"
}

session = requests.Session()
session.mount("https://", LegacySSLAdapter())

proxies = {
    "http": None,
    "https": None
}

# è¿™é‡Œç§»é™¤äº† verify=Falseï¼Œå› ä¸ºå·²ç»åœ¨é€‚é…å™¨é‡Œç»Ÿä¸€é…ç½®äº†
r = session.post(
    url,
    headers=headers,
    json=payload,
    timeout=15,
    proxies=proxies
)

print(r.status_code)
print(r.text)
```
</div>
</details>

**ç»“æœï¼š**
![2](/img/in-post/python_img/å±å¹•æˆªå›¾%202026-01-25%20163806.png)

## çˆ¬å–è¿‘äº”å¹´æ•°æ®

<details>
<summary>ç‚¹å‡»å±•å¼€/æŠ˜å ä»£ç </summary>
<div markdown="1">

```python
import os
import time
import ssl
import requests
import pandas as pd
from datetime import datetime, timedelta
from urllib3.poolmanager import PoolManager
from urllib3.util.ssl_ import create_urllib3_context

# ===============================
# 1. å½»åº•ç¦ç”¨ä»£ç†
# ===============================
os.environ["HTTP_PROXY"] = ""
os.environ["HTTPS_PROXY"] = ""
os.environ["ALL_PROXY"] = ""

# ===============================
# 2. SSL Adapterï¼ˆé“¶è¡Œä¸“ç”¨ï¼‰
# ===============================
class LegacySSLAdapter(requests.adapters.HTTPAdapter):
    def init_poolmanager(self, connections, maxsize, block=False):
        ctx = create_urllib3_context()
        ctx.options |= 0x4  # OP_LEGACY_SERVER_CONNECT
        ctx.check_hostname = False
        ctx.verify_mode = ssl.CERT_NONE
        self.poolmanager = PoolManager(
            num_pools=connections,
            maxsize=maxsize,
            block=block,
            ssl_context=ctx
        )

# ===============================
# 3. è¯·æ±‚åŸºç¡€é…ç½®
# ===============================
URL = "https://papi.icbc.com.cn/exchanges/ns/history"

HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
    "Content-Type": "application/json",
    "Origin": "https://www.icbc.com.cn",
    "Referer": "https://www.icbc.com.cn/ICBC/"
}

PROXIES = {"http": None, "https": None}

# ===============================
# 4. åˆ›å»º Session
# ===============================
session = requests.Session()
session.mount("https://", LegacySSLAdapter())

# ===============================
# 5. å•æ—¥æŠ“å–å‡½æ•°ï¼ˆå¸¦é‡è¯•ï¼‰
# ===============================
def fetch_one_day(date_str, max_retry=3):
    payload = {
        "date": date_str,
        "currType": "",
        "serverType": "1"
    }

    for attempt in range(1, max_retry + 1):
        try:
            r = session.post(
                URL,
                headers=HEADERS,
                json=payload,
                timeout=15,
                proxies=PROXIES
            )
            r.raise_for_status()
            data = r.json()

            if data.get("code") == 0:
                return data["data"]

            print(f"[WARN] {date_str} è¿”å›å¼‚å¸¸ code: {data}")
            return None

        except Exception as e:
            print(f"[RETRY {attempt}] {date_str} å¤±è´¥: {e}")
            time.sleep(2 * attempt)

    return None

# ===============================
# 6. æ—¶é—´èŒƒå›´ï¼ˆè¿‘ 5 å¹´ï¼‰
# ===============================
end_date = datetime.today()
start_date = end_date - timedelta(days=5 * 365)

# ===============================
# 7. ä¸»å¾ªç¯
# ===============================
all_rows = []
missing_dates = []

current = start_date
while current <= end_date:
    date_str = current.strftime("%Y-%m-%d")
    print(f"ğŸ“… æŠ“å– {date_str}")

    day_data = fetch_one_day(date_str)

    if not day_data:
        missing_dates.append(date_str)
    else:
        for item in day_data:
            all_rows.append({
                "date": date_str,
                "currencyENName": item.get("currencyENName"),
                "currencyCHName": item.get("currencyCHName"),
                "reference": item.get("reference"),
                "foreignBuy": item.get("foreignBuy"),
                "foreignSell": item.get("foreignSell"),
                "cashBuy": item.get("cashBuy"),
                "cashSell": item.get("cashSell"),
            })

    time.sleep(0.5)  # é“¶è¡Œæ¥å£ï¼Œåˆ«å¤ªçŒ›
    current += timedelta(days=1)

session.close()

# ===============================
# 8. DataFrame & CSV
# ===============================
df = pd.DataFrame(all_rows)
csv_path = os.path.join(os.path.dirname(__file__), "icbc_exchange_5y.csv")
df.to_csv(csv_path, index=False, encoding="utf-8-sig")

print("\nâœ… æ•°æ®æŠ“å–å®Œæˆ")
print(f"ğŸ“„ CSV æ–‡ä»¶ï¼š{csv_path}")
print(f"ğŸ“Š æ€»è®°å½•æ•°ï¼š{len(df)}")

if missing_dates:
    print(f"âš ï¸ ç¼ºå¤±æ—¥æœŸ ({len(missing_dates)}):")
    print(missing_dates)
else:
    print("ğŸ‰ æ— ç¼ºå¤±æ—¥æœŸ")

```
</div>
</details>
